// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Represents a physical or logical location for inventory
model Location {
  id          String @id @default(cuid())
  name        String @unique // e.g., "Warehouse", "Pharmacy Shop"
  description String?
  createdAt   DateTime @default(now())

  // Relations
  StockLevels StockLevel[]
  SaleItems   SaleItem[] // Tracks which location a sale was made from

  @@map("locations")
}

model Product {
  id        String   @id @default(cuid())
  sku       String   @unique
  name      String
  cost      Decimal  @db.Decimal(10, 2) @default(0.00)
  price     Decimal  @db.Decimal(10, 2)
  uom       String   @default("Unit") // Measure of Unit (MoU)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  StockLevels      StockLevel[]
  SaleItems        SaleItem[]
  StockIntakeItems StockIntakeItem[]

  @@map("products")
}

model StockIntake {
  id        String   @id @default(cuid())
  intakeId  String   @unique
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items StockIntakeItem[]

  @@map("stock_intakes")
}

model StockIntakeItem {
  id       String  @id @default(cuid())
  sku      String
  quantity Int
  unit     String // "pcs" or "pack"
  cost     Decimal @db.Decimal(10, 2)
  price    Decimal @db.Decimal(10, 2)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  intakeId String
  intake   StockIntake @relation(fields: [intakeId], references: [id], onDelete: Cascade)

  @@map("stock_intake_items")
}

// A join table to track stock of a product at a specific location
model StockLevel {
  quantity Int @default(0)

  // Relations
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  location  Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  locationId String

  @@id([productId, locationId]) // Composite primary key to ensure one entry per product/location
  @@map("stock_levels")
}

model Sale {
  id          String   @id @default(cuid())
  totalAmount Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  // Relations
  SaleItems SaleItem[]

  @@map("sales")
}

model SaleItem {
  id          String @id @default(cuid())
  quantity    Int
  priceAtSale Decimal @db.Decimal(10, 2) // Price at the time of sale

  // Relations
  sale     Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleId   String
  product  Product  @relation(fields: [productId], references: [id])
  productId String
  location Location @relation(fields: [locationId], references: [id]) // The location where the sale occurred
  locationId String

  @@map("sale_items")
}

// Simple model for the Accounting page
model Expense {
  id          String   @id @default(cuid())
  description String
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  @@map("expenses")
}
